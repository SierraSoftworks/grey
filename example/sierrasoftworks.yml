---
probes:
  - name: rex.production
    policy:
      interval: 30000
      timeout: 5000
      retries: 2
    target: !Http
      url: https://rex.sierrasoftworks.com/api/v1/health
    validators:
      http.status: !OneOf [200]
  - name: rex.staging
    policy:
      interval: 60000
      timeout: 5000
      retries: 2
    target: !Http
      url: https://rex-staging.sierrasoftworks.com/api/v1/health
    validators:
      http.status: !OneOf [200]
  - name: bender.production
    policy:
      interval: 30000
      timeout: 5000
      retries: 2
    target: !Http
      url: https://bender.sierrasoftworks.com/api/v1/health
    validators:
      http.status: !OneOf [200]
  - name: vault.production
    policy:
      interval: 60000
      timeout: 5000
      retries: 2
    target: !Http
      url: https://vault.sierrasoftworks.com/v1/sys/health
      method: HEAD
    validators:
      http.status: !OneOf [200, 429, 473]
  - name: bender.development
    policy:
      interval: 60000
      timeout: 1000
      retries: 2
    target: !Http
      url: http://localhost:8000/api/v1/quote/Bender
    validators:
      http.status: !OneOf [200]
      http.body: !Contains "Bender"
  - name: bender.production.script
    policy:
      interval: 60000
      timeout: 5000
      retries: 2
    target: !Script
      args:
        - https://bender.sierrasoftworks.com
      code: |
        console.log(`Running trace ID ${getTraceHeaders()}`)

        const resp = await fetch(`${Deno.args[0]}/api/v1/quote/bender`, {
          headers: {
            "Accept": "application/json",
            ...getTraceHeaders()
          }
        })

        setOutput("http.status", resp.status)

        if (resp.ok) {
          const quote = await resp.json()
          setOutput("quote.who", quote.who)
        }

    validators:
      http.status: !Equals 200
      quote.who: !Equals "Bender"